
#include <stdint.h>
#include <string.h>

typedef unsigned int uint;

typedef uint8_t   u8;
typedef uint32_t u32;
typedef uint16_t u16;
typedef uint64_t u64;

#define popcount64 __builtin_popcountll

// TODO:
#if 1
#define BE64 __builtin_bswap64
#else
#define BE64
#endif
#define BE8

static inline u64 swap64q (const u64 x, const uint q) {

    return (x >> q) | (x << (64 - q));
}

static inline u64 swap64 (const u64 x) {

    return swap64q(x, popcount64(x));
}

typedef u64 u64x8  __attribute__ ((vector_size( 8 * sizeof(u64)))); // 512
typedef u64 u64x4  __attribute__ ((vector_size( 4 * sizeof(u64)))); // 256
typedef u64 u64x2  __attribute__ ((vector_size( 2 * sizeof(u64)))); // 128

typedef u32 u32x16 __attribute__ ((vector_size(16 * sizeof(u32)))); // 512
typedef u32 u32x8  __attribute__ ((vector_size( 8 * sizeof(u32)))); // 256
typedef u32 u32x4  __attribute__ ((vector_size( 4 * sizeof(u32)))); // 128

typedef u8 u8x64  __attribute__ ((vector_size(64 * sizeof(u8)))); // 512
typedef u8 u8x32  __attribute__ ((vector_size(32 * sizeof(u8)))); // 256
typedef u8 u8x16  __attribute__ ((vector_size(16 * sizeof(u8)))); // 128

// __attribute__((target("popcnt", "avx2")))

// NOTE: THE HASH IS SAVED BIG ENDIAN
void __attribute__((optimize("-O3", "-ffast-math", "-fstrict-aliasing"))) xhash (const u8* restrict data, uint size, u8* const restrict hash) {

    // ACUMULATORS
    u8x64 A = {
            0b01101001, 0b00101101, 0b00101110, 0b01100001, 0b01110100, 0b00010101, 0b10001011, 0b01001100,
            0b11011110, 0b01110011, 0b00101001, 0b00001110, 0b10111110, 0b00000011, 0b00010110, 0b10010001,
            0b01101011, 0b00011000, 0b10111110, 0b00101101, 0b10100001, 0b10110110, 0b00011010, 0b00110100,
            0b10010000, 0b10010101, 0b11010101, 0b01101011, 0b10001110, 0b10111010, 0b00011000, 0b00111111,
            0b00101110, 0b11001110, 0b11100010, 0b10101110, 0b00110001, 0b10110010, 0b01101110, 0b01011111,
            0b11011100, 0b11110010, 0b11011010, 0b01100000, 0b11010011, 0b00010000, 0b10101000, 0b11001110,
            0b10000010, 0b10111011, 0b11110101, 0b01110111, 0b00000000, 0b00101100, 0b11011111, 0b11001100,
            0b00011110, 0b01110101, 0b10110001, 0b01001001, 0b10110101, 0b00011110, 0b10010011, 0b00010100
    };

    // SWAPPERS
    u8x64 X[8] = {
        {
            0b11100101, 0b11001000, 0b11100000, 0b10001110, 0b01011011, 0b00100111, 0b10110001, 0b00010110,
            0b10011100, 0b10000100, 0b10011011, 0b10111000, 0b01111010, 0b11011010, 0b11100011, 0b11010011,
            0b11101000, 0b10000010, 0b00100111, 0b01000010, 0b10101010, 0b00011000, 0b00100111, 0b00110000,
            0b01010001, 0b10110111, 0b00001010, 0b00101110, 0b00111111, 0b11111000, 0b00110010, 0b10110101,
            0b01101110, 0b10010100, 0b10101010, 0b01000110, 0b01110101, 0b00010100, 0b10110110, 0b11101011,
            0b10101011, 0b00010000, 0b00111000, 0b11011011, 0b10011011, 0b11010110, 0b11100110, 0b00001111,
            0b01100000, 0b10111111, 0b00011100, 0b10011111, 0b01000100, 0b00110101, 0b00111001, 0b11101011,
            0b01100001, 0b11111010, 0b10010110, 0b11110010, 0b10110001, 0b10011110, 0b00010110, 0b00000001
        },{
            0b10101111, 0b00010101, 0b01110101, 0b11000110, 0b00100001, 0b11101100, 0b01110001, 0b00111110,
            0b10110000, 0b10000100, 0b00010010, 0b11011100, 0b01011010, 0b11111011, 0b10011001, 0b10011110,
            0b10100011, 0b01000101, 0b01010001, 0b11101000, 0b00100011, 0b01001110, 0b00110111, 0b01000001,
            0b10011010, 0b10101010, 0b10000111, 0b11110100, 0b11000100, 0b10101010, 0b10011001, 0b01100111,
            0b00001101, 0b10000110, 0b01100000, 0b11101100, 0b10000010, 0b01101101, 0b10000011, 0b00111100,
            0b01111011, 0b00101100, 0b00110001, 0b10011101, 0b11100110, 0b00000010, 0b11111100, 0b01111101,
            0b10011110, 0b10111111, 0b00000100, 0b00100000, 0b10101010, 0b11100111, 0b00111010, 0b01101011,
            0b10001101, 0b10110111, 0b00100111, 0b00011100, 0b11100001, 0b10010101, 0b11000011, 0b01101110
        },{
            0b00001001, 0b11100011, 0b10010111, 0b01011010, 0b10011011, 0b01101010, 0b11101110, 0b11100000,
            0b10101001, 0b10010001, 0b11000101, 0b00010110, 0b10100000, 0b10111101, 0b01110000, 0b01001101,
            0b10001010, 0b01001110, 0b01100010, 0b10000000, 0b11011101, 0b00100100, 0b11011001, 0b11101100,
            0b11010101, 0b11001100, 0b00110110, 0b01011011, 0b10101010, 0b00011000, 0b11101111, 0b00111110,
            0b01111010, 0b00100011, 0b00100101, 0b00100111, 0b01010011, 0b11011100, 0b01111111, 0b11010110,
            0b00001101, 0b11010011, 0b00000000, 0b11011100, 0b00011111, 0b00111100, 0b00111111, 0b01000110,
            0b00001001, 0b01101101, 0b11100001, 0b00100100, 0b00110111, 0b01001110, 0b00110110, 0b01010101,
            0b00010111, 0b00001001, 0b01000011, 0b10100101, 0b00101110, 0b00110111, 0b01111011, 0b10010001
        },{
            0b00111010, 0b01010001, 0b00100101, 0b11110110, 0b10110000, 0b01000001, 0b10101011, 0b11010111,
            0b01001000, 0b11110110, 0b10001101, 0b10001111, 0b11111010, 0b10111111, 0b11110111, 0b01000001,
            0b10111010, 0b00101000, 0b10110101, 0b10101110, 0b01000111, 0b11111111, 0b11111011, 0b01001000,
            0b10001010, 0b00010100, 0b10000111, 0b10000011, 0b01010100, 0b10001110, 0b01100010, 0b01111001,
            0b01000000, 0b11010001, 0b10010010, 0b11101000, 0b01000000, 0b10000110, 0b00110100, 0b00111100,
            0b11001011, 0b00000101, 0b00100000, 0b00011001, 0b10000111, 0b11001000, 0b01011000, 0b10011011,
            0b00001101, 0b01100101, 0b11111111, 0b11001111, 0b11111101, 0b11100100, 0b01010110, 0b00110011,
            0b00000100, 0b10011001, 0b11111101, 0b00101100, 0b10011011, 0b10000110, 0b11100101, 0b11000100
        },{
            0b01110011, 0b10010001, 0b00100111, 0b10110100, 0b01010001, 0b10011000, 0b01001001, 0b00000100,
            0b11001010, 0b10000010, 0b00010010, 0b10101100, 0b11010100, 0b10010110, 0b00111100, 0b01111001,
            0b11011011, 0b00101111, 0b00011000, 0b11101000, 0b00000111, 0b00111001, 0b11010011, 0b00111100,
            0b00000011, 0b01001111, 0b00111001, 0b01000101, 0b10001101, 0b11101111, 0b01111111, 0b00111000,
            0b00110111, 0b01001010, 0b00110000, 0b01110011, 0b11011110, 0b00010111, 0b11110111, 0b11111101,
            0b11101011, 0b00100010, 0b00111100, 0b01111100, 0b01100100, 0b00110110, 0b01100000, 0b00100100,
            0b11111100, 0b01001010, 0b10011101, 0b10101011, 0b01010011, 0b10010101, 0b11101111, 0b10001000,
            0b11000000, 0b00111110, 0b10000000, 0b00011100, 0b11101110, 0b11101100, 0b11100110, 0b11100000
        },{
            0b11101111, 0b01101100, 0b00101001, 0b01110010, 0b01001000, 0b11100101, 0b10111111, 0b10011010,
            0b10000111, 0b11101110, 0b10111101, 0b10111010, 0b01000000, 0b00000101, 0b00111001, 0b11111010,
            0b10000000, 0b01011110, 0b00100011, 0b00000101, 0b10001111, 0b10011001, 0b10101011, 0b11010111,
            0b11001101, 0b11011000, 0b10000111, 0b11101100, 0b00000010, 0b11110100, 0b10001001, 0b01110001,
            0b00011101, 0b11001111, 0b10110111, 0b10000011, 0b10101111, 0b11111111, 0b10010101, 0b11111000,
            0b01111101, 0b00010000, 0b10100001, 0b00000000, 0b00011001, 0b11110100, 0b00001001, 0b00101111,
            0b11000001, 0b00100110, 0b01010101, 0b00001101, 0b10010101, 0b11101110, 0b11011000, 0b00011000,
            0b01010010, 0b11000001, 0b01100010, 0b00110110, 0b00001100, 0b10111011, 0b10010100, 0b00111001
        },{
            0b10000101, 0b11010110, 0b10100011, 0b11001111, 0b00000010, 0b00010111, 0b01000100, 0b11111101,
            0b10010100, 0b10100010, 0b10111101, 0b10101010, 0b10011000, 0b10011011, 0b11110001, 0b11100110,
            0b11000111, 0b10010111, 0b11010011, 0b01100011, 0b10100100, 0b01011000, 0b10001011, 0b01000110,
            0b01110011, 0b01100100, 0b11100000, 0b00101011, 0b11101100, 0b11011011, 0b10110101, 0b10010000,
            0b01000010, 0b10000001, 0b10001010, 0b10010000, 0b01100010, 0b01101101, 0b10111111, 0b10010010,
            0b11000011, 0b00111111, 0b01100101, 0b10101111, 0b11111001, 0b10011111, 0b01001001, 0b00000011,
            0b10011111, 0b10000011, 0b01000001, 0b00100000, 0b00010111, 0b00001100, 0b01001000, 0b00010011,
            0b01011000, 0b01011000, 0b01100111, 0b10111110, 0b10110111, 0b11100001, 0b01111110, 0b11101100
        },{
            0b00111110, 0b11101011, 0b11100100, 0b01011100, 0b01011110, 0b00000001, 0b11111011, 0b00011110,
            0b01100110, 0b11001001, 0b01100101, 0b01010100, 0b10011011, 0b11111000, 0b11001110, 0b10101110,
            0b01111010, 0b01011100, 0b01001001, 0b00001110, 0b00000110, 0b00101011, 0b11010011, 0b01110000,
            0b00101110, 0b11100001, 0b10110001, 0b10011100, 0b11101000, 0b00111110, 0b00100001, 0b00110100,
            0b00100011, 0b00101110, 0b11100111, 0b01101110, 0b11001010, 0b11101001, 0b10000000, 0b11110000,
            0b01111100, 0b00010101, 0b01001000, 0b01101001, 0b00100110, 0b00011000, 0b11010110, 0b01011111,
            0b00000111, 0b11110110, 0b11110111, 0b00010001, 0b00110110, 0b00100100, 0b11001000, 0b01110101,
            0b00110010, 0b00111000, 0b01101100, 0b00110001, 0b10100010, 0b11011011, 0b00110011, 0b11110101
        }
    };

    // SIZE DEPENDENT
    //A *= size;

    while (size) {

        u64 w;

        if (size >= sizeof(u64)) {
            size -= sizeof(u64);
            w = BE64(*(u64*)data);
            data += sizeof(u64);
        } else {
            size -= sizeof(u8);
            w = BE8(*(u8*)data);
            data += sizeof(u8);
        }

        // ACCUMULATE
        X[7] += X[6] ^= X[5] += X[4] ^= X[3] += X[2] ^= X[1] += X[0] ^= A +=
            (u8x64) (
                ( (u64x8) {
                    0b0000000100000001000000010000000100000001000000010000000100000001ULL,
                    0b0000001000000010000000100000001000000010000000100000001000000010ULL,
                    0b0000010000000100000001000000010000000100000001000000010000000100ULL,
                    0b0000100000001000000010000000100000001000000010000000100000001000ULL,
                    0b0001000000010000000100000001000000010000000100000001000000010000ULL,
                    0b0010000000100000001000000010000000100000001000000010000000100000ULL,
                    0b0100000001000000010000000100000001000000010000000100000001000000ULL,
                    0b1000000010000000100000001000000010000000100000001000000010000000ULL,
                } ) & w
            );

        //
        A += __builtin_shuffle(X[popcount64(w) & 0b111], ((u8x64)(((u64x8)A) >> popcount64(w))) & 0b111);
    }

    // SAVE
    // WARNING: ENDIANESS
    memcpy(hash, &A, sizeof(A));
}

// FOR SPEED
// WE CAN ALWAYS DO A EVEN DEEPER CHECK BY VERIFYING THE HASH OF THE FILES
void __attribute__((optimize("-O3", "-ffast-math", "-fstrict-aliasing"))) xcsum (const void* restrict data, uint size, void* restrict csum) {

    u8x64 A = {
        0x65, 0xAD, 0xA6, 0x3A, 0xD5, 0x6F, 0xC9, 0xB5,
        0x57, 0xD9, 0xAE, 0x14, 0x4D, 0x88, 0x70, 0xED,
        0xEA, 0x65, 0x22, 0xBE, 0xC7, 0x81, 0xFB, 0xD2,
        0xBB, 0x29, 0xE0, 0x3E, 0x64, 0xC7, 0x44, 0xF7,
        0x42, 0x11, 0x5F, 0xAE, 0x08, 0xE4, 0x8A, 0x14,
        0xAF, 0x1C, 0xC4, 0x46, 0xBD, 0x2F, 0xD0, 0x2F,
        0x2A, 0xDB, 0xE1, 0x30, 0xBB, 0xC1, 0xAA, 0x21,
        0x64, 0x4C, 0xCE, 0x63, 0x12, 0x27, 0x1B, 0x4D
    };

    while (size) {

        u64 w;

        if (size >= sizeof(u64)) {
            size -= sizeof(u64);
            w = BE64(*(u64*)data);
            data += sizeof(u64);
        } else {
            size -= sizeof(u8);
            w = BE8(*(u8*)data);
            data += sizeof(u8);
        }

        // ACCUMULATE
        A += (u8x64)(((u64x8){
            0b0000000100000001000000010000000100000001000000010000000100000001ULL,
            0b0000001000000010000000100000001000000010000000100000001000000010ULL,
            0b0000010000000100000001000000010000000100000001000000010000000100ULL,
            0b0000100000001000000010000000100000001000000010000000100000001000ULL,
            0b0001000000010000000100000001000000010000000100000001000000010000ULL,
            0b0010000000100000001000000010000000100000001000000010000000100000ULL,
            0b0100000001000000010000000100000001000000010000000100000001000000ULL,
            0b1000000010000000100000001000000010000000100000001000000010000000ULL,
        }) & w);

        // O FATO DE SER PALAVRINHAS DE 8-BITS TAMBEM SIGNIFICA QUE VAI TER MAIS BITS QUE NÃO DÃO OVERFLOW =]
        A += __builtin_shuffle(A, (A >> popcount64(w)) & 0b111111U);
    }

    // SAVE
    memcpy(csum, &A, sizeof(A));
}
