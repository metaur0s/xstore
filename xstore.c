
#include <stdint.h>
#include <string.h>

typedef unsigned int uint;

typedef uint8_t   u8;
typedef uint32_t u32;
typedef uint16_t u16;
typedef uint64_t u64;

#define popcount64 __builtin_popcountll

// TODO:
#if 1
#define BE64 __builtin_bswap64
#else
#define BE64
#endif
#define BE8

static inline u64 swap64q (const u64 x, const uint q) {

    return (x >> q) | (x << (64 - q));
}

static inline u64 swap64 (const u64 x) {

    return swap64q(x, popcount64(x));
}

typedef u64 u64x8  __attribute__ ((vector_size( 8 * sizeof(u64)))); // 512
typedef u64 u64x4  __attribute__ ((vector_size( 4 * sizeof(u64)))); // 256
typedef u64 u64x2  __attribute__ ((vector_size( 2 * sizeof(u64)))); // 128

typedef u32 u32x16 __attribute__ ((vector_size(16 * sizeof(u32)))); // 512
typedef u32 u32x8  __attribute__ ((vector_size( 8 * sizeof(u32)))); // 256
typedef u32 u32x4  __attribute__ ((vector_size( 4 * sizeof(u32)))); // 128

typedef u8 u8x64  __attribute__ ((vector_size(64 * sizeof(u8)))); // 512
typedef u8 u8x32  __attribute__ ((vector_size(32 * sizeof(u8)))); // 256
typedef u8 u8x16  __attribute__ ((vector_size(16 * sizeof(u8)))); // 128

// __attribute__((target("popcnt", "avx2")))

// NOTE: THE HASH IS SAVED BIG ENDIAN
void __attribute__((optimize("-O3", "-ffast-math", "-fstrict-aliasing"))) xhash (const void* restrict data, uint size, void* const restrict hash) {

    // ACUMULATORS
    u64x8 A = {
        0b1001011011000010101110010101100111100011110100011100101111001110ULL,
        0b0001110111100100011010111001100010101100110101100111010001111011ULL,
        0b0111011001111001000000000001001000011000011011000110001001101001ULL,
        0b0010010110000101000111110011000011010110001001110001110111100100ULL,
        0b0100110011101010111111111011111110010011000011010001110100011011ULL,
        0b0101010100011101110111010110111110001101110010101100100000000100ULL,
        0b0100000000100110000111011011111010000001110100101111010000110111ULL,
        0b1101101100011101110110100100011001011011000000100001110001001011ULL,
    };

    // SWAPPERS
    u64x8 X[8] = {
        {
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        },{
            0b0011000011001001111000110101111000100001001101010100011010010010ULL,
            0b1011101110000001010110111011101011110110010111011011011100001010ULL,
            0b0001000101110101110011101010110011100110110010100010101010000010ULL,
            0b1101000011101000010100011111110011100101001111110000100000011101ULL,
            0b0110011110100010010011001001011011110101110110101101101010100110ULL,
            0b0110100101100011001110100001101001100100110111101111110001001010ULL,
            0b1011110011101100100110110011001010001110001110011101111100100001ULL,
            0b0101010011100011001000000011001010011101110100000001100101100100ULL
        }
    };

    // SIZE DEPENDENT
    A *= size;

    while (size) {

        u64 w;

        if (size >= sizeof(u64)) {
            size -= sizeof(u64);
            w = BE64(*(u64*)data);
            data += sizeof(u64);
        } else {
            size -= sizeof(u8);
            w = BE8(*(u8*)data);
            data += sizeof(u8);
        }

        // ACCUMULATE
        X[7] += X[6] ^= X[5] += X[4] ^= A += X[3] ^= X[2] += X[1] ^= X[0] += ((u64x8){
            0b0000000100000001000000010000000100000001000000010000000100000001ULL,
            0b0000001000000010000000100000001000000010000000100000001000000010ULL,
            0b0000010000000100000001000000010000000100000001000000010000000100ULL,
            0b0000100000001000000010000000100000001000000010000000100000001000ULL,
            0b0001000000010000000100000001000000010000000100000001000000010000ULL,
            0b0010000000100000001000000010000000100000001000000010000000100000ULL,
            0b0100000001000000010000000100000001000000010000000100000001000000ULL,
            0b1000000010000000100000001000000010000000100000001000000010000000ULL,
        }) & w;

        //
        A += __builtin_shuffle(X[popcount64(w) % 8], (A >> popcount64(w)) % 8);
    }

    // SAVE
    // WARNING: ENDIANESS
    memcpy(hash, &A, sizeof(A));
}

// FOR SPEED
// WE CAN ALWAYS DO A EVEN DEEPER CHECK BY VERIFYING THE HASH OF THE FILES
void __attribute__((optimize("-O3", "-ffast-math", "-fstrict-aliasing"))) xcsum (const void* restrict data, uint size, void* restrict csum) {

    u8x64 A = {
        0x65, 0xAD, 0xA6, 0x3A, 0xD5, 0x6F, 0xC9, 0xB5,
        0x57, 0xD9, 0xAE, 0x14, 0x4D, 0x88, 0x70, 0xED,
        0xEA, 0x65, 0x22, 0xBE, 0xC7, 0x81, 0xFB, 0xD2,
        0xBB, 0x29, 0xE0, 0x3E, 0x64, 0xC7, 0x44, 0xF7,
        0x42, 0x11, 0x5F, 0xAE, 0x08, 0xE4, 0x8A, 0x14,
        0xAF, 0x1C, 0xC4, 0x46, 0xBD, 0x2F, 0xD0, 0x2F,
        0x2A, 0xDB, 0xE1, 0x30, 0xBB, 0xC1, 0xAA, 0x21,
        0x64, 0x4C, 0xCE, 0x63, 0x12, 0x27, 0x1B, 0x4D
    };

    while (size) {

        u64 w;

        if (size >= sizeof(u64)) {
            size -= sizeof(u64);
            w = BE64(*(u64*)data);
            data += sizeof(u64);
        } else {
            size -= sizeof(u8);
            w = BE8(*(u8*)data);
            data += sizeof(u8);
        }

        // ACCUMULATE
        A += (u8x64)(((u64x8){
            0b0000000100000001000000010000000100000001000000010000000100000001ULL,
            0b0000001000000010000000100000001000000010000000100000001000000010ULL,
            0b0000010000000100000001000000010000000100000001000000010000000100ULL,
            0b0000100000001000000010000000100000001000000010000000100000001000ULL,
            0b0001000000010000000100000001000000010000000100000001000000010000ULL,
            0b0010000000100000001000000010000000100000001000000010000000100000ULL,
            0b0100000001000000010000000100000001000000010000000100000001000000ULL,
            0b1000000010000000100000001000000010000000100000001000000010000000ULL,
        }) & w);

        // O FATO DE SER PALAVRINHAS DE 8-BITS TAMBEM SIGNIFICA QUE VAI TER MAIS BITS QUE NÃO DÃO OVERFLOW =]
        A += __builtin_shuffle(A, (A >> popcount64(w)) & 0b111111U);
    }

    // SAVE
    memcpy(csum, &A, sizeof(A));
}
